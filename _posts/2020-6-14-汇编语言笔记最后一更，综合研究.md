---
layout: post
title: 汇编语言笔记最后一更，综合研究
subtitle: 汇编语言笔记最后一更，综合研究
date: 2020-06-14
author: nightmare-man
tags: 8086汇编 demo

---

# 汇编语言笔记最后一更，综合研究

### 0x00 结语

​		王爽老师在书的结尾设立了一个综合研究部分，为了深入研究有关问题：

![QQ截图20200614074806](/assets/img/QQ截图20200614074806.png)

​		针对①c语言中能不使用变量吗？②c语言可以不用main函数吗③如何不定参数的函数如何实现？这三个我们在学习c语言时常被忽视的问题作者进行了追问，并警醒读者：

​		**都在用，我们就非得用吗？**

​		**规定了，我们就只知道遵守吗？**

​		**司空见惯，我们就不怀疑了吗？**

​		作为一个学者，或者说技术爱好者，学习时必定要有这种打破砂锅问到底的研究劲头，否则只是按图索骥，难有真的收获和深入的体验，如果是作为工作，那是另一种情况，在此不论。

​		下面就针对这三个问题展开研究



### 0x01 搭建dos下的精简的c语言环境

​		根据系统的不同，c语言有不同的集成开发环境，dos系统下的IDE(intergrated development environment)是turbo c，我是用turbo c 2.0和dosbox（没有用bochs运行dos太麻烦了）

​		tc2.0目录下文件很多

![QQ截图20200614075934](/assets/img/QQ截图20200614075934.png)

​		为了知道哪些程序和文件用于解决我们的问题，在d盘新建一个文件夹minic，然后一个文件一个文件地复制到minc的方法，然后用命令mount c d:/minic   把minc挂在成dos的c盘，找到最小的tc开发环境。

​		执行命令c: 进入minc文件加，windows下把tc.exe复制到minc，然后dos下执行命令tc.exe

![QQ截图20200614080721](/assets/img/QQ截图20200614080721.png)	

​		然后清楚options中directions里的所有路径（这都是开发环境的依赖文件，都删除，即设置为当前路径，也就是和tc同一目录），写下如图代码并在compile中compile to obj

![QQ截图20200614081530](/assets/img/QQ截图20200614081530.png)

  ![QQ截图20200614081725](/assets/img/QQ截图20200614081725.png)

​		然后我们试着link链接，报错了

![QQ截图20200614081835](/assets/img/QQ截图20200614081835.png)

​		根据提示导入c0s.obj再次尝试，仍然报错，于是依次导入缺少文件

![QQ截图20200614082002](/assets/img/QQ截图20200614082002.png)

​		终于在添加cs.lib,c0s.obj,emu.lib,graphics.lib,maths.lib后链接成功得到test.exe

![QQ截图20200614082503](/assets/img/QQ截图20200614082503.png)

![QQ截图20200614082545](/assets/img/QQ截图20200614082545.png)

​		运行成功



### 0x02 c语言中使用寄存器

​		汇编中我们把数据储存到寄存器或者内存空间，我们试着在c中使用，支持下图寄存器，几乎所有了

![QQ截图20200614082811](/assets/img/QQ截图20200614082811.png)

编写程序

```c
main()
{
    _AX=1;
    _BX=1;
    _CX=2;
    _AX=_BX+_CX;
    _AH=_BL+_CL;
    _AL=_BH+_CH;
}
```

​		1编译链接后用debug运行(需要把debug也导入到minic文件夹)，u命令观察编译后的汇编代码，我看了下，从cs:0到出现第一个ret，中间好多代码啊。。

​		2思考main函数的代码在什么段中，用debug怎么找到url.exe中的main函数？ main函数作为代码当然在代码段 段地址和debug中的cs对应，但是怎么找到我就不会了

​		3用下面的方法打印出test.exe被加载运行时，main函数在代码段中的偏移地址:

```c
main()
{
    prinf("%x\n",main);
}
```

![QQ截图20200614085734](/assets/img/QQ截图20200614085734.png)

![QQ截图20200614090602](/assets/img/QQ截图20200614090602.png)

​		上图时cs:1fa对应的代码，可以看到01fa是作为一个常数地址常数出现（是不是和汇编里的地址标号很相似？）的，所以我推测上面代码之所以能打印mian的地址，**是编译器把main作为一个地址标号处理**，编译时直接作为一个地址常数，所以pirntf里放的mian不是一个变量，是一个地址常数

​		结尾的ret告诉我们，c语言里的mian函数在汇编里是子程序

​		研究下面的代码，验证上面的推测

```c
void f(void);
main(){
    _AX=1;
    _BX=1;
    _CX=2;
    f();
}
void f(void){
    _AX=_BX+_CX;
}
```

![QQ截图20200614091655](/assets/img/QQ截图20200614091655.png)

![QQ截图20200614091744](/assets/img/QQ截图20200614091744.png)

​		图一对应main函数 图二对应f函数



### 0x03 使用内存空间

//买菜去了，待更新