---
layout: post
title: CSAPP笔记06虚拟内存（下）
subtitle: CSAPP笔记06虚拟内存（下）
date: 2020-08-17
author: nightmare-man
tags: 计算机组成原理
---
# CSAPP笔记06虚拟内存（下）

### 0x00 x86-64linux内存系统

​	**x86-64地址翻译** 

​	x86-64处理器理论上支持2^64byte的虚拟地址空间，但是现阶段都只开放48位或者56位的虚拟地址。未利用地高位地址都用0填充。

​	现代x86-64处理器采用四级页表层次结构，每个进程有自己的私有页表层次。并且x86-64处理器允许页表中地址段为NULL，也就是未分配的虚拟地址对应的页表被换出到磁盘上，但是**如果已经分配了，那就必须驻留在内存里。**CR3控制寄存器储存**当前进程的**第一级页表的物理基地址，每次上下文切换时，CR3的值也会被切换。

​	![image-20200817102325134](/assets/img/image-20200817102325134.png)

​	以上是翻译的流程。VPN是 vitrual page number，即虚拟页号，VPO是virtual page offset，虚拟地址偏移。VPN又被分为四个段，对应四级页面的不同部分。

![image-20200817102516217](/assets/img/image-20200817102516217.png)

​	**前三级页表的条目的地址都记录的是下一级页表的物理机地址，而第四级页表的条目记录的是虚拟页对应的物理页地址或者磁盘地址**。由于虚拟页和物理页的大小相同，且VPO PPO位数相同，所以最终的翻译地址就是物理页地址/磁盘地址+偏移。

​	上图中还列出了TLB，TLB是对页表的高速缓存，以免每次访问内存都要先读页表。同样，对于在主存的数据，先检查在不在SRAM缓存中。

​	另外，观察上图的PTE条目，属性字段除了P有效位外，还有R/W位用来控制虚拟页的读写属性；U/S用来防止用户态修改内核数据；XD用来控制是否可执行，可以用来实现不可执行栈。

​	

​	**linux虚拟内存系统**

​	![image-20200817103837664](/assets/img/image-20200817103837664.png)

​	linux为每个进程维护一个单独的地址空间。用户态上包含用户程序代码、数据、堆、共享库以及栈（该进程用户态的栈）。

​	每个进程在虚拟地址空间的顶端，是内核态的代码和数据。内核储存在所有进程共享的物理页面（即映射到每个进程的虚拟地址空间）。比如共享的内核的代码和全局数据。

​	而内核为了自己更方便的访问内存，**又在内核虚拟地址空间（也就是每个进程的虚拟地址空间的顶端）中一组连续的虚拟页面直接映射到连续的全部物理地址。**（比如内核要访问该进程的页表，实现这样的映射后，放问页表就很直接了）。

​	但是每个进程的内核虚拟地址空间中也有不共享的页，比如，指向页表本身物理地址的页，不同进程的内核栈，以及**记录虚拟地址空间结构的各种数据结构**：

​	**①linux虚拟内存区域**

​	linux将已经分配的**一组连续的虚拟地址空间**（虚拟页）组织成**区域**。比如，代码段、数据段、堆、贡献库和用户栈都是**不同的区域**。

![image-20200817105759432](/assets/img/image-20200817105759432.png)

​		linux使用链表来记录所有的区域，每个区域节点记录了该区域对应的虚拟地址的start和end。当在进程中引用一个地址时，内核会先根据这个链表来查找这个虚拟地址属于哪个区域，**如果不属于任何区域，那么该对该虚拟地址的访问是非法的**。所以，**我们分配虚拟地址空间，要么归属于新建一个区域，要么归属于原有的区域。**

​	上图中的vm_area_struct结构即记录了所有区域。内核为了管理不同进程，为每个进程维护了一个**task_struct任务结构**，task_struct (即task state segment，TSS的加强版)，其中mm_struct结构记录虚拟内存的当前状态，里面既包含了当前进程的页表第一级的物理基地址，又包含了vm_struct_area区域的集合。	

​	让我们仔细审查上面的vm_struct_area区域节点，包含了下面的字段：

​	![image-20200817110856621](/assets/img/image-20200817110856621.png)

​	start和end是包含的虚拟地址的起始地址，而prot（protection）这个区域里所有页的读写许可权限（**天啊，PTE页表条目上有读写属性，这里又有，不过这个是所有位于区域里的页的**）。而flags则是下面会讲到的，共享还是私有区域。next则构成链表。